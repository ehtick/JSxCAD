import { boot } from '@jsxcad/sys';
import { canonicalize } from '@jsxcad/geometry';
import { fromSvgPath } from './fromSvgPath.js';
import test from 'ava';
import { toPdf } from '@jsxcad/convert-pdf';

test.beforeEach(async (t) => {
  await boot();
});

// TODO: Add colinear point simplification.

test('Parse an open triangle.', async (t) => {
  const svgPath =
    'M200 100 L170.71067810058594 170.71067810058594 L100 200 L29.289321899414062 170.71067810058594 ' +
    'L0 100 L29.289321899414062 29.289321899414062 L100 0 L170.71067810058594 29.289321899414062';
  const paths = canonicalize(
    fromSvgPath(new TextEncoder('utf8').encode(svgPath))
  );
  t.is(
    new TextDecoder('utf8').decode(await toPdf(paths)),
    `%PDF-1.5
1 0 obj << /Pages 2 0 R /Type /Catalog >> endobj
2 0 obj << /Count 1 /Kids [ 3 0 R ] /Type /Pages >> endobj
3 0 obj <<
  /Contents 4 0 R
  /MediaBox [ -14.173228338 -581.102361839 581.102361839 14.173228338 ]
  /TrimBox [ 0.000000000 -566.929133501 566.929133501 0.000000000 ]
  /Parent 2 0 R
  /Type /Page
>>
endobj
4 0 obj << >>
stream
0.096000000 w
0.000000000 0.000000000 0.000000000 RG
484.904289459 -82.024844042 m
284.464566751 1.000000000 l
84.024844042 -82.024844042 l
1.000000000 -282.464566751 l
6.447480312 -295.615990364 l
84.024844042 -482.904289459 l
284.464566751 -565.929133501 l
484.904289459 -482.904289459 l
567.929133501 -282.464566751 l
S
endstream
endobj
trailer << /Root 1 0 R /Size 4 >>
%%EOF`
  );
});

test('Parse a closed triangle.', async (t) => {
  const svgPath =
    'M200 100 L170.71067810058594 170.71067810058594 L100 200 L29.289321899414062 170.71067810058594 ' +
    'L0 100 L29.289321899414062 29.289321899414062 L100 0 L170.71067810058594 29.289321899414062 Z';
  const paths = canonicalize(
    fromSvgPath(new TextEncoder('utf8').encode(svgPath))
  );
  t.is(
    new TextDecoder('utf8').decode(await toPdf(paths)),
    `%PDF-1.5
1 0 obj << /Pages 2 0 R /Type /Catalog >> endobj
2 0 obj << /Count 1 /Kids [ 3 0 R ] /Type /Pages >> endobj
3 0 obj <<
  /Contents 4 0 R
  /MediaBox [ -14.173228338 -581.102361839 581.102361839 14.173228338 ]
  /TrimBox [ 0.000000000 -566.929133501 566.929133501 0.000000000 ]
  /Parent 2 0 R
  /Type /Page
>>
endobj
4 0 obj << >>
stream
0.096000000 w
0.000000000 0.000000000 0.000000000 RG
567.690966572 -281.889587223 m
484.904289459 -82.024844042 l
284.464566751 1.000000000 l
84.024844042 -82.024844042 l
1.000000000 -282.464566751 l
84.024844042 -482.904289459 l
284.464566751 -565.929133501 l
484.904289459 -482.904289459 l
567.929133501 -282.464566751 l
h
S
endstream
endobj
trailer << /Root 1 0 R /Size 4 >>
%%EOF`
  );
});

test('Parse a circle with a hole.', async (t) => {
  const svgPath =
    'M 950,81 A 107,107 0 0,1 950,295 A 107,107 0 0,1 950,81 z ' +
    'M 950,139 A 49,49 0 0,0 950,237 A 49,49 0 0,0 950,139 z';
  const paths = canonicalize(
    fromSvgPath(new TextEncoder('utf8').encode(svgPath))
  );
  t.is(
    new TextDecoder('utf8').decode(await toPdf(paths)),
    `%PDF-1.5
1 0 obj << /Pages 2 0 R /Type /Catalog >> endobj
2 0 obj << /Count 1 /Kids [ 3 0 R ] /Type /Pages >> endobj
3 0 obj <<
  /Contents 4 0 R
  /MediaBox [ 2375.433069370 -850.393700252 3010.393698891 -215.433070730 ]
  /TrimBox [ 2389.606297707 -836.220471914 2996.220470554 -229.606299068 ]
  /Parent 2 0 R
  /Type /Page
>>
endobj
4 0 obj << >>
stream
0.096000000 w
0.000000000 0.000000000 0.000000000 RG
2678.305229810 -229.000966784 m
2647.722719593 -232.101077019 l
2618.112209375 -238.155199849 l
2589.626231440 -247.010888033 l
2562.417233032 -258.515665978 l
2536.637633048 -272.517086442 l
2512.439907079 -288.862673833 l
2489.976559062 -307.399980908 l
2469.399979547 -327.976560423 l
2450.862672473 -350.439908440 l
2434.517085081 -374.637634409 l
2420.515664618 -400.417234393 l
2409.010886672 -427.626232801 l
2400.155198489 -456.112210736 l
2394.101075658 -485.722720953 l
2391.000965424 -516.305231170 l
2390.606297707 -531.913385491 l
2391.000965424 -547.521539812 l
2394.101075658 -578.104050029 l
2400.155198489 -607.714560246 l
2409.010886672 -636.200538181 l
2420.515664618 -663.409536589 l
2434.517085081 -689.189136573 l
2450.862672473 -713.386862542 l
2469.399979547 -735.850210559 l
2489.976559062 -756.426790074 l
2512.439907079 -774.964097149 l
2536.637633048 -791.309684540 l
2562.417233032 -805.311105004 l
2589.626231440 -816.815882949 l
2618.112209375 -825.671571133 l
2647.722719593 -831.725693964 l
2678.305229810 -834.825804198 l
2693.913384130 -835.220471914 l
2709.521538451 -834.825804198 l
2740.104048668 -831.725693964 l
2769.714558886 -825.671571133 l
2798.200536821 -816.815882949 l
2825.409535229 -805.311105004 l
2851.189135212 -791.309684540 l
2875.386861181 -774.964097149 l
2897.850209199 -756.426790074 l
2918.426788713 -735.850210559 l
2936.964095788 -713.386862542 l
2953.309683180 -689.189136573 l
2967.311103643 -663.409536589 l
2978.815881589 -636.200538181 l
2987.671569772 -607.714560246 l
2993.725692603 -578.104050029 l
2996.825802837 -547.521539812 l
2997.220470554 -531.913385491 l
2996.825802837 -516.305231170 l
2993.725692603 -485.722720953 l
2987.671569772 -456.112210736 l
2978.815881589 -427.626232801 l
2967.311103643 -400.417234393 l
2953.309683180 -374.637634409 l
2936.964095788 -350.439908440 l
2918.426788713 -327.976560423 l
2897.850209199 -307.399980908 l
2875.386861181 -288.862673833 l
2851.189135212 -272.517086442 l
2825.409535229 -258.515665978 l
2798.200536821 -247.010888033 l
2769.714558886 -238.155199849 l
2740.104048668 -232.101077019 l
2709.521538451 -229.000966784 l
2693.913384130 -228.606299068 l
h
S
2693.913384130 -393.015747783 m
2686.765740040 -393.196484791 l
2672.760634537 -394.616160381 l
2659.200710137 -397.388613922 l
2646.155727468 -401.444028093 l
2633.695503853 -406.712557223 l
2621.889913310 -413.124412338 l
2610.808716466 -420.609776112 l
2600.521758992 -429.098831225 l
2591.098829865 -438.521760353 l
2582.609774752 -448.808717827 l
2575.124410977 -459.889914670 l
2568.712555863 -471.695505214 l
2563.444026732 -484.155728828 l
2559.388612562 -497.200711497 l
2556.616159020 -510.760635898 l
2555.196483430 -524.765741401 l
2555.015746423 -531.913385491 l
2555.196483430 -539.061029581 l
2556.616159020 -553.066135084 l
2559.388612562 -566.626059485 l
2563.444026732 -579.671042154 l
2568.712555863 -592.131265768 l
2575.124410977 -603.936856312 l
2582.609774752 -615.018053155 l
2591.098829865 -625.305010629 l
2600.521758992 -634.727939757 l
2610.808716466 -643.216994870 l
2621.889913310 -650.702358645 l
2633.695503853 -657.114213759 l
2646.155727468 -662.382742889 l
2659.200710137 -666.438157060 l
2672.760634537 -669.210610601 l
2686.765740040 -670.630286191 l
2693.913384130 -670.811023199 l
2701.061028220 -670.630286191 l
2715.066133723 -669.210610601 l
2728.626058124 -666.438157060 l
2741.671040793 -662.382742889 l
2754.131264407 -657.114213759 l
2765.936854951 -650.702358645 l
2777.018051795 -643.216994870 l
2787.305009268 -634.727939757 l
2796.727938396 -625.305010629 l
2805.216993509 -615.018053155 l
2812.702357284 -603.936856312 l
2819.114212398 -592.131265768 l
2824.382741529 -579.671042154 l
2828.438155699 -566.626059485 l
2831.210609241 -553.066135084 l
2832.630284830 -539.061029581 l
2832.811021838 -531.913385491 l
2832.630284830 -524.765741401 l
2831.210609241 -510.760635898 l
2828.438155699 -497.200711497 l
2824.382741529 -484.155728828 l
2819.114212398 -471.695505214 l
2812.702357284 -459.889914670 l
2805.216993509 -448.808717827 l
2796.727938396 -438.521760353 l
2787.305009268 -429.098831225 l
2777.018051795 -420.609776112 l
2765.936854951 -413.124412338 l
2754.131264407 -406.712557223 l
2741.671040793 -401.444028093 l
2728.626058124 -397.388613922 l
2715.066133723 -394.616160381 l
2701.061028220 -393.196484791 l
h
S
endstream
endobj
trailer << /Root 1 0 R /Size 4 >>
%%EOF`
  );
});
