import { boot } from '@jsxcad/sys';
import { canonicalize } from '@jsxcad/geometry';
import { fromSvgPath } from './fromSvgPath.js';
import test from 'ava';
import { toSvg } from './toSvg.js';

test.beforeEach(async (t) => {
  await boot();
});

// TODO: Add colinear point simplification.

test('Parse an open triangle.', async (t) => {
  const svgPath =
    'M200 100 L170.71067810058594 170.71067810058594 L100 200 L29.289321899414062 170.71067810058594 ' +
    'L0 100 L29.289321899414062 29.289321899414062 L100 0 L170.71067810058594 29.289321899414062';
  const geometry = fromSvgPath(new TextEncoder('utf8').encode(svgPath), {
    normalizeCoordinateSystem: true,
  });
  t.is(
    new TextDecoder('utf8').decode(await toSvg(geometry)),
    `<?xml version="1.0" encoding="UTF-8"?>
<!-- Generated by jsxcad -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1 Tiny//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11-tiny.dtd">
<svg baseProfile="tiny" height="200mm" width="200mm" viewBox="0 -200 200 200" version="1.1" stroke="black" stroke-width=".1" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill="#000000" stroke="none" d="M 200 100 L 170.71067810058594 170.71067810058594 L 100 200 L 29.289321899414062 170.71067810058594 L 0 100 L 29.289321899414062 29.289321899414062 L 100 0 L 170.71067810058594 29.289321899414062"/>
</svg>`
  );
});

test('Parse a closed triangle.', async (t) => {
  const svgPath =
    'M200 100 L170.71067810058594 170.71067810058594 L100 200 L29.289321899414062 170.71067810058594 ' +
    'L0 100 L29.289321899414062 29.289321899414062 L100 0 L170.71067810058594 29.289321899414062 Z';
  const geometry = canonicalize(
    fromSvgPath(new TextEncoder('utf8').encode(svgPath))
  );
  t.is(
    new TextDecoder('utf8').decode(await toSvg(geometry)),
    `<?xml version="1.0" encoding="UTF-8"?>
<!-- Generated by jsxcad -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1 Tiny//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11-tiny.dtd">
<svg baseProfile="tiny" height="200mm" width="200mm" viewBox="0 0 200 200" version="1.1" stroke="black" stroke-width=".1" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill="#000000" stroke="none" d="M 200 -100 L 170.71067810058594 -170.71067810058594 L 100 -200 L 29.289321899414062 -170.71067810058594 L 0 -100 L 29.289321899414062 -29.289321899414062 L 100 0 L 170.71067810058594 -29.289321899414062 z"/>
</svg>`
  );
});

test('Parse a circle with a hole.', async (t) => {
  const svgPath =
    'M 950,81 A 107,107 0 0,1 950,295 A 107,107 0 0,1 950,81 z ' +
    'M 950,139 A 49,49 0 0,0 950,237 A 49,49 0 0,0 950,139 z';
  const geometry = canonicalize(
    fromSvgPath(new TextEncoder('utf8').encode(svgPath))
  );
  t.is(
    new TextDecoder('utf8').decode(await toSvg(geometry)),
    `<?xml version="1.0" encoding="UTF-8"?>
<!-- Generated by jsxcad -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1 Tiny//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11-tiny.dtd">
<svg baseProfile="tiny" height="214mm" width="214mm" viewBox="843 81 214 214" version="1.1" stroke="black" stroke-width=".1" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill="#000000" stroke="none" d="M 950 -81 L 955.5062058078782 -81.13922773603619 L 966.2950448622807 -82.23288059614339 L 976.7409671055839 -84.36864324433631 L 986.790188462635 -87.49273160546221 L 996.3889248582811 -91.55136160436828 L 1005.4833922173696 -96.49074916590166 L 1014.0198064647476 -102.25711021490955 L 1021.9443835252623 -108.79666067623918 L 1029.203339323761 -116.05561647473777 L 1035.7428897850905 -123.98019353525245 L 1041.509250834098 -132.51660778263044 L 1046.4486383956319 -141.6110751417189 L 1050.5072683945377 -151.2098115373651 L 1053.6313567556635 -161.25903289441618 L 1055.7671194038567 -171.70495513771937 L 1056.8607722639638 -182.49379419212178 L 1057 -188 L 1056.8607722639638 -193.50620580787822 L 1055.7671194038567 -204.29504486228063 L 1053.6313567556635 -214.74096710558382 L 1050.5072683945377 -224.7901884626349 L 1046.4486383956319 -234.3889248582811 L 1041.509250834098 -243.48339221736956 L 1035.7428897850905 -252.01980646474757 L 1029.203339323761 -259.9443835252623 L 1021.9443835252623 -267.2033393237608 L 1014.0198064647476 -273.7428897850905 L 1005.4833922173696 -279.50925083409834 L 996.3889248582811 -284.44863839563175 L 986.790188462635 -288.5072683945378 L 976.7409671055839 -291.63135675566366 L 966.2950448622807 -293.7671194038566 L 955.5062058078782 -294.8607722639638 L 950 -295 L 944.4937941921218 -294.8607722639638 L 933.7049551377193 -293.7671194038566 L 923.2590328944161 -291.63135675566366 L 913.209811537365 -288.5072683945378 L 903.6110751417189 -284.44863839563175 L 894.5166077826304 -279.50925083409834 L 885.9801935352524 -273.7428897850905 L 878.0556164747377 -267.2033393237608 L 870.7966606762391 -259.9443835252623 L 864.2571102149095 -252.01980646474757 L 858.4907491659015 -243.48339221736956 L 853.5513616043683 -234.3889248582811 L 849.4927316054623 -224.7901884626349 L 846.3686432443363 -214.74096710558382 L 844.2328805961433 -204.29504486228063 L 843.1392277360362 -193.50620580787822 L 843 -188 L 843.1392277360362 -182.49379419212178 L 844.2328805961433 -171.70495513771937 L 846.3686432443363 -161.25903289441618 L 849.4927316054623 -151.2098115373651 L 853.5513616043683 -141.6110751417189 L 858.4907491659015 -132.51660778263044 L 864.2571102149095 -123.98019353525245 L 870.7966606762391 -116.05561647473777 L 878.0556164747377 -108.79666067623918 L 885.9801935352524 -102.25711021490955 L 894.5166077826304 -96.49074916590166 L 903.6110751417189 -91.55136160436828 L 913.209811537365 -87.49273160546221 L 923.2590328944161 -84.36864324433631 L 933.7049551377193 -82.23288059614339 L 944.4937941921218 -81.13922773603619 L 950 -81 M 950 -139 L 947.478466499196 -139.0637584959418 L 942.5377831939088 -139.5645901795423 L 937.7541365591252 -140.5426497100232 L 933.1521566853355 -141.97330699689394 L 928.7564736630302 -143.831931949664 L 924.5917175827 -146.0938944778428 L 920.6825185348353 -148.73456449093993 L 917.0535066099267 -151.7293118984647 L 913.7293118984646 -155.05350660992661 L 910.73456449094 -158.68251853483522 L 908.0938944778427 -162.5917175826999 L 905.831931949664 -166.75647366303016 L 903.9733069968939 -171.15215668533543 L 902.5426497100232 -175.75413655912516 L 901.5645901795424 -180.5377831939089 L 901.0637584959418 -185.47846649919595 L 901 -188 L 901.0637584959418 -190.52153350080405 L 901.5645901795424 -195.4622168060911 L 902.5426497100232 -200.24586344087484 L 903.9733069968939 -204.84784331466457 L 905.831931949664 -209.24352633696984 L 908.0938944778427 -213.4082824173001 L 910.73456449094 -217.31748146516478 L 913.7293118984646 -220.94649339007339 L 917.0535066099267 -224.2706881015353 L 920.6825185348353 -227.26543550906007 L 924.5917175827 -229.9061055221572 L 928.7564736630302 -232.168068050336 L 933.1521566853355 -234.02669300310606 L 937.7541365591252 -235.4573502899768 L 942.5377831939088 -236.4354098204577 L 947.478466499196 -236.9362415040582 L 950 -237 L 952.521533500804 -236.9362415040582 L 957.4622168060912 -236.4354098204577 L 962.2458634408748 -235.4573502899768 L 966.8478433146645 -234.02669300310606 L 971.2435263369698 -232.168068050336 L 975.4082824173 -229.9061055221572 L 979.3174814651647 -227.26543550906007 L 982.9464933900733 -224.2706881015353 L 986.2706881015354 -220.94649339007339 L 989.26543550906 -217.31748146516478 L 991.9061055221573 -213.4082824173001 L 994.168068050336 -209.24352633696984 L 996.0266930031061 -204.84784331466457 L 997.4573502899768 -200.24586344087484 L 998.4354098204576 -195.4622168060911 L 998.9362415040582 -190.52153350080405 L 999 -188 L 998.9362415040582 -185.47846649919595 L 998.4354098204576 -180.5377831939089 L 997.4573502899768 -175.75413655912516 L 996.0266930031061 -171.15215668533543 L 994.168068050336 -166.75647366303016 L 991.9061055221573 -162.5917175826999 L 989.26543550906 -158.68251853483522 L 986.2706881015354 -155.05350660992661 L 982.9464933900733 -151.7293118984647 L 979.3174814651647 -148.73456449093993 L 975.4082824173 -146.0938944778428 L 971.2435263369698 -143.831931949664 L 966.8478433146645 -141.97330699689394 L 962.2458634408748 -140.5426497100232 L 957.4622168060912 -139.5645901795423 L 952.521533500804 -139.0637584959418 L 950 -139"/>
</svg>`
  );
});
