import { boot } from '@jsxcad/sys';
import { canonicalize } from '@jsxcad/geometry';
import { fromSvgPath } from './fromSvgPath.js';
import test from 'ava';
import { toPdf } from '@jsxcad/convert-pdf';

test.beforeEach(async (t) => {
  await boot();
});

// TODO: Add colinear point simplification.

test('Parse an open triangle.', async (t) => {
  const svgPath =
    'M200 100 L170.71067810058594 170.71067810058594 L100 200 L29.289321899414062 170.71067810058594 ' +
    'L0 100 L29.289321899414062 29.289321899414062 L100 0 L170.71067810058594 29.289321899414062';
  const paths = canonicalize(
    fromSvgPath(new TextEncoder('utf8').encode(svgPath))
  );
console.dir(JSON.parse(JSON.stringify(paths)), { depth: null });
console.log(new TextDecoder('utf8').decode(await toPdf(paths)));
  t.is(
    new TextDecoder('utf8').decode(await toPdf(paths)),
    `%PDF-1.5
1 0 obj << /Pages 2 0 R /Type /Catalog >> endobj
2 0 obj << /Count 1 /Kids [ 3 0 R ] /Type /Pages >> endobj
3 0 obj <<
  /Contents 4 0 R
  /MediaBox [ -14.173228338 -581.102361839 581.102361839 14.173228338 ]
  /TrimBox [ 0.000000000 -566.929133501 566.929133501 0.000000000 ]
  /Parent 2 0 R
  /Type /Page
>>
endobj
4 0 obj << >>
stream
0.096000000 w
0.000000000 0.000000000 0.000000000 RG
484.680260000 -81.986406667 m
284.333333333 1.000000000 l
83.986406667 -81.986406667 l
1.000000000 -282.333333333 l
6.444958333 -295.478668333 l
83.986406667 -482.680260000 l
284.333333333 -565.666666667 l
484.680260000 -482.680260000 l
567.666666667 -282.333333333 l
S
endstream
endobj
trailer << /Root 1 0 R /Size 4 >>
%%EOF`
  );
});

test('Parse a closed triangle.', async (t) => {
  const svgPath =
    'M200 100 L170.71067810058594 170.71067810058594 L100 200 L29.289321899414062 170.71067810058594 ' +
    'L0 100 L29.289321899414062 29.289321899414062 L100 0 L170.71067810058594 29.289321899414062 Z';
  const paths = canonicalize(
    fromSvgPath(new TextEncoder('utf8').encode(svgPath))
  );
  t.is(
    new TextDecoder('utf8').decode(await toPdf(paths)),
    `%PDF-1.5
1 0 obj << /Pages 2 0 R /Type /Catalog >> endobj
2 0 obj << /Count 1 /Kids [ 3 0 R ] /Type /Pages >> endobj
3 0 obj <<
  /Contents 4 0 R
  /MediaBox [ -14.173228338 -581.102361839 581.102361839 14.173228338 ]
  /TrimBox [ 0.000000000 -566.929133501 566.929133501 0.000000000 ]
  /Parent 2 0 R
  /Type /Page
>>
endobj
4 0 obj << >>
stream
0.096000000 w
0.000000000 0.000000000 0.000000000 RG
567.428610000 -281.758620000 m
484.680260000 -81.986406667 l
284.333333333 1.000000000 l
83.986406667 -81.986406667 l
1.000000000 -282.333333333 l
83.986406667 -482.680260000 l
284.333333333 -565.666666667 l
484.680260000 -482.680260000 l
567.666666667 -282.333333333 l
h
S
endstream
endobj
trailer << /Root 1 0 R /Size 4 >>
%%EOF`
  );
});

test('Parse a circle with a hole.', async (t) => {
  const svgPath =
    'M 950,81 A 107,107 0 0,1 950,295 A 107,107 0 0,1 950,81 z ' +
    'M 950,139 A 49,49 0 0,0 950,237 A 49,49 0 0,0 950,139 z';
  const paths = canonicalize(
    fromSvgPath(new TextEncoder('utf8').encode(svgPath))
  );
  t.is(
    new TextDecoder('utf8').decode(await toPdf(paths)),
    `%PDF-1.5
1 0 obj << /Pages 2 0 R /Type /Catalog >> endobj
2 0 obj << /Count 1 /Kids [ 3 0 R ] /Type /Pages >> endobj
3 0 obj <<
  /Contents 4 0 R
  /MediaBox [ 2375.433069370 -850.393700252 3010.393698891 -215.433070730 ]
  /TrimBox [ 2389.606297707 -836.220471914 2996.220470554 -229.606299068 ]
  /Parent 2 0 R
  /Type /Page
>>
endobj
4 0 obj << >>
stream
0.096000000 w
0.000000000 0.000000000 0.000000000 RG
2677.065738333 -228.894485000 m
2646.497386667 -231.993160000 l
2616.900585000 -238.044480000 l
2588.427795000 -246.896068333 l
2561.231393333 -258.395520000 l
2535.463728333 -272.390458333 l
2511.277205000 -288.728478333 l
2488.824256667 -307.257203333 l
2468.257203333 -327.824256667 l
2449.728478333 -350.277205000 l
2433.390458333 -374.463728333 l
2419.395520000 -400.231393333 l
2407.896068333 -427.427795000 l
2399.044480000 -455.900585000 l
2392.993160000 -485.497386667 l
2389.894485000 -516.065738333 l
2389.500000000 -531.666666667 l
2389.894485000 -547.267595000 l
2392.993160000 -577.835946667 l
2399.044480000 -607.432748333 l
2407.896068333 -635.905538333 l
2419.395520000 -663.101940000 l
2433.390458333 -688.869605000 l
2449.728478333 -713.056128333 l
2468.257203333 -735.509076667 l
2488.824256667 -756.076130000 l
2511.277205000 -774.604855000 l
2535.463728333 -790.942875000 l
2561.231393333 -804.937813333 l
2588.427795000 -816.437265000 l
2616.900585000 -825.288853333 l
2646.497386667 -831.340173333 l
2677.065738333 -834.438848333 l
2692.666666667 -834.833333333 l
2708.267595000 -834.438848333 l
2738.835946667 -831.340173333 l
2768.432748333 -825.288853333 l
2796.905538333 -816.437265000 l
2824.101940000 -804.937813333 l
2849.869605000 -790.942875000 l
2874.056128333 -774.604855000 l
2896.509076667 -756.076130000 l
2917.076130000 -735.509076667 l
2935.604855000 -713.056128333 l
2951.942875000 -688.869605000 l
2965.937813333 -663.101940000 l
2977.437265000 -635.905538333 l
2986.288853333 -607.432748333 l
2992.340173333 -577.835946667 l
2995.438848333 -547.267595000 l
2995.833333333 -531.666666667 l
2995.438848333 -516.065738333 l
2992.340173333 -485.497386667 l
2986.288853333 -455.900585000 l
2977.437265000 -427.427795000 l
2965.937813333 -400.231393333 l
2951.942875000 -374.463728333 l
2935.604855000 -350.277205000 l
2917.076130000 -327.824256667 l
2896.509076667 -307.257203333 l
2874.056128333 -288.728478333 l
2849.869605000 -272.390458333 l
2824.101940000 -258.395520000 l
2796.905538333 -246.896068333 l
2768.432748333 -238.044480000 l
2738.835946667 -231.993160000 l
2708.267595000 -228.894485000 l
2692.666666667 -228.500000000 l
h
S
2692.666666667 -392.833333333 m
2685.522331667 -393.013986667 l
2671.523710000 -394.433005000 l
2657.970063333 -397.204175000 l
2644.931120000 -401.257711667 l
2632.476665000 -406.523801667 l
2620.676540000 -412.932688333 l
2609.600473333 -420.414586667 l
2599.318278333 -428.899711667 l
2589.899711667 -438.318278333 l
2581.414586667 -448.600473333 l
2573.932688333 -459.676540000 l
2567.523801667 -471.476665000 l
2562.257711667 -483.931120000 l
2558.204175000 -496.970063333 l
2555.433005000 -510.523710000 l
2554.013986667 -524.522331667 l
2553.833333333 -531.666666667 l
2554.013986667 -538.811001667 l
2555.433005000 -552.809623333 l
2558.204175000 -566.363270000 l
2562.257711667 -579.402213333 l
2567.523801667 -591.856668333 l
2573.932688333 -603.656793333 l
2581.414586667 -614.732860000 l
2589.899711667 -625.015055000 l
2599.318278333 -634.433621667 l
2609.600473333 -642.918746667 l
2620.676540000 -650.400645000 l
2632.476665000 -656.809531667 l
2644.931120000 -662.075621667 l
2657.970063333 -666.129158333 l
2671.523710000 -668.900328333 l
2685.522331667 -670.319346667 l
2692.666666667 -670.500000000 l
2699.811001667 -670.319346667 l
2713.809623333 -668.900328333 l
2727.363270000 -666.129158333 l
2740.402213333 -662.075621667 l
2752.856668333 -656.809531667 l
2764.656793333 -650.400645000 l
2775.732860000 -642.918746667 l
2786.015055000 -634.433621667 l
2795.433621667 -625.015055000 l
2803.918746667 -614.732860000 l
2811.400645000 -603.656793333 l
2817.809531667 -591.856668333 l
2823.075621667 -579.402213333 l
2827.129158333 -566.363270000 l
2829.900328333 -552.809623333 l
2831.319346667 -538.811001667 l
2831.500000000 -531.666666667 l
2831.319346667 -524.522331667 l
2829.900328333 -510.523710000 l
2827.129158333 -496.970063333 l
2823.075621667 -483.931120000 l
2817.809531667 -471.476665000 l
2811.400645000 -459.676540000 l
2803.918746667 -448.600473333 l
2795.433621667 -438.318278333 l
2786.015055000 -428.899711667 l
2775.732860000 -420.414586667 l
2764.656793333 -412.932688333 l
2752.856668333 -406.523801667 l
2740.402213333 -401.257711667 l
2727.363270000 -397.204175000 l
2713.809623333 -394.433005000 l
2699.811001667 -393.013986667 l
h
S
endstream
endobj
trailer << /Root 1 0 R /Size 4 >>
%%EOF`
  );
});
